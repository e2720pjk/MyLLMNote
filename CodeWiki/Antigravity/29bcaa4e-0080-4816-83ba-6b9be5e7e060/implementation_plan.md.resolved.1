# MCP Display and Status Logic Fixes

## Goal Description
This plan addresses two distinct issues affecting the MCP user experience:
1.  **Display Glitch**: The UI displays raw ANSI escape codes (e.g., `\u001b[32m`) instead of rendered colors because [HistoryItemDisplay](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/components/HistoryItemDisplay.tsx#48-178) aggressively sanitizes all messages.
2.  **Status Logic**: The MCP status incorrectly shows "Not Authenticated" instead of "Token Expired" because the storage layer ([getCredentials](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/src/mcp/token-storage/base-token-storage.ts#16-19)) returns `null` for expired tokens, preventing the UI from detecting the expiration state.

## User Review Required
> [!IMPORTANT]
> **Security Implication**: We are relaxing the sanitization in [HistoryItemDisplay.tsx](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/components/HistoryItemDisplay.tsx). This is safe because we are only skipping it for trusted message types (`info`, `error`, `warning`, `oauth_url`) generated by the system, not user input.
> **Behavior Change**: [getCredentials](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/src/mcp/token-storage/base-token-storage.ts#16-19) will now return expired tokens. This is a desired change to match the legacy API behavior and allow the UI to handle expiration logic.

## Proposed Changes

### CLI UI Layer
#### [MODIFY] [HistoryItemDisplay.tsx](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/components/HistoryItemDisplay.tsx)
-   Modify the `useMemo` hook to conditionally apply [escapeAnsiCtrlCodes](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/utils/textUtils.ts#124-188).
-   Skip sanitization for `info`, `error`, `warning`, and `oauth_url` message types.
-   Continue sanitizing `user` and `user_shell` messages to prevent injection.

### Core Storage Layer
#### [MODIFY] [file-token-storage.ts](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/src/mcp/token-storage/file-token-storage.ts)
-   Remove the [isTokenExpired](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/src/mcp/oauth-token-storage.ts#103-112) check in [getCredentials](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/src/mcp/token-storage/base-token-storage.ts#16-19).

#### [MODIFY] [keychain-token-storage.ts](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/src/mcp/token-storage/keychain-token-storage.ts)
-   Remove the [isTokenExpired](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/src/mcp/oauth-token-storage.ts#103-112) check in [getCredentials](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/src/mcp/token-storage/base-token-storage.ts#16-19).

### Package Dependencies
#### [MODIFY] [packages/core/package.json](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/core/package.json)
-   Add `keytar` to `optionalDependencies` to ensure secure storage support on macOS.

## Verification Plan

### Manual Verification
1.  **Display Fix**:
    -   Run `/mcp list`.
    -   Verify that the output shows colored text (e.g., green `[READY]`) instead of raw ANSI codes.
2.  **Status Fix**:
    -   Manually modify a stored token in `~/.llxprt/mcp-oauth-tokens-v2.json` (or keychain) to have an `expiresAt` in the past.
    -   Run `/mcp list`.
    -   Verify that the status shows [(OAuth token expired)](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/utils/textUtils.ts#37-40) in yellow, instead of [(OAuth not authenticated)](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/utils/textUtils.ts#37-40) in red.
