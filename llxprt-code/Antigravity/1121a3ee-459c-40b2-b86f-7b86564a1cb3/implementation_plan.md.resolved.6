# Refine TODO Tab and Fix Redraw Logic

This plan addresses issues with the TODO tab integration, layout stability, and redraw failures when switching tabs.

## User Review Required

> [!IMPORTANT]
> - Switching tabs will now trigger a full terminal clear and static re-render to ensure a clean UI state. This is necessary to resolve redraw issues with complex components like tool call windows.
> - The TODO tab will be refactored to use the same logic as the Chat and Debug tabs, which may change its internal structure but will ensure it respects terminal height constraints and supports scrolling.

## Proposed Changes

### UI Components

#### [MODIFY] [MainContent.tsx](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/ui/components/MainContent.tsx)
- Use `uiState.staticKey` instead of `uiState.historyRemountKey` for `Static` components in all tabs to ensure `refreshStatic()` triggers a correct remount and terminal clear.
- Refactor `todo` tab content to use the same [ScrollableList](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/ui/components/shared/ScrollableList.tsx#40-153) / `Static` pattern as [Debug](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/config/config.ts#673-681) tab.
- Define `todoVirtualizedData` (for virtualized mode) that includes [AppHeader](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/components/AppHeader.tsx#18-33) and the [TodoPanel](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/ui/components/TodoPanel.tsx#26-29).
- Ensure the [TodoPanel](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/ui/components/TodoPanel.tsx#26-29) is properly centered/padded and doesn't cause layout shifting by using `flexGrow={1}` or high-level height constraints in the [MainContent](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/components/MainContent.tsx#57-395) container.

#### [MODIFY] [TodoPanel.tsx](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/ui/components/TodoPanel.tsx)
- Update [useVerticalResponsive](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/ui/components/TodoPanel.tsx#35-50) to use `availableTerminalHeight` from context if available, rather than hardcoded `rows - 8`, reaching out to `UIStateContext` if necessary.
- Align header styling (`Todo Progress`) with [McpStatus](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/ui/components/McpStatus.tsx#16-50) (e.g. Yellow, bold, underline) for UI consistency across specialized tabs.
- Ensure the main `Box` doesn't use `borderStyle="round"` if it's already inside a constrained container that handles borders (optional, based on visual fit).

### Contexts & Hooks

#### [MODIFY] [AppContainer.tsx](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-4/packages/cli/src/ui/AppContainer.tsx)
- Update [setActiveTab](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/AppContainer.tsx#1825-1829) to explicitly call `refreshStatic()`. This ensures that switching tabs clears the terminal and triggers a clean re-render, resolving redraw artifacts (like missing tool call windows).

## Verification Plan

### Automated Tests
- `npm run preflight` to ensure no regressions.
- Verify that `staticKey` change doesn't cause excessive re-renders during normal operation.

### Manual Verification
1. Open a conversation with tool calls.
2. Switch to Debug tab and then back to Chat tab. Verify tool call windows redraw correctly.
3. Switch to TODO tab. Verify it doesn't "push up" the TabBar and follows the $H$ constraints.
4. Add many todos and verify the TODO tab scrolls correctly.
