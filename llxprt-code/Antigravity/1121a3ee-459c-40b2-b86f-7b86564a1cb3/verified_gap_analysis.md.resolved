# é©—è­‰å¾Œçš„ Phase 1 å¯¦æ–½ç¼ºå£åˆ†æ

## ğŸ“‹ å¯©æŸ¥å ±å‘ŠçœŸå¯¦æ€§é©—è­‰

**çµè«–**ï¼šå¯©æŸ¥å ±å‘Š **85% æº–ç¢º**ï¼Œä½†æœ‰éƒ¨åˆ†èª¤åˆ¤èˆ‡éåº¦è§£è®€ã€‚

---

## âœ… é©—è­‰ç¢ºèªæ­£ç¢ºçš„éƒ¨åˆ†

### 1. useRenderMode å¯¦æ–½ âœ…
**å¯©æŸ¥å ±å‘Šè²ç¨±**ï¼šé‚è¼¯å®Œå…¨æ­£ç¢º
**å¯¦éš›é©—è­‰**ï¼šâœ… **æº–ç¢º**

```typescript
// packages/cli/src/ui/hooks/useRenderMode.ts
export const useRenderMode = (): RenderMode => {
  const settings = useSettings();
  const isScreenReaderEnabled = useIsScreenReaderEnabled();
  const isAltBufferEnabled = isAlternateBufferEnabled(settings);

  // Use static rendering for screen readers or when alternate buffer is disabled
  if (isScreenReaderEnabled || !isAltBufferEnabled) {
    return 'static';
  }

  // Use virtualized rendering for optimal performance with alternate buffer
  return 'virtualized';
};
```

**è©•åƒ¹**ï¼šé‚è¼¯æ¸…æ™°ï¼Œæ¯” gemini-cli æ›´ç°¡æ½”ã€‚

---

### 2. UIStateContext æ›´æ–° âœ…
**å¯©æŸ¥å ±å‘Šè²ç¨±**ï¼šæ­£ç¢ºæ·»åŠ  `historyRemountKey` å’Œ `pendingHistory`
**å¯¦éš›é©—è­‰**ï¼šâœ… **æº–ç¢º**

```typescript
// packages/cli/src/ui/contexts/UIStateContext.tsx (Line 51, 57)
export interface UIState {
  history: HistoryItem[];
  pendingHistory: HistoryItem[]; // Dynamic history for alternate buffer
  historyRemountKey: number;      // History remount key for forcing re-renders
  // ...
}
```

---

### 3. ScreenReaderAppLayout ç¼ºå¤± âœ…
**å¯©æŸ¥å ±å‘Šè²ç¨±**ï¼šå®Œå…¨ç¼ºå¤±
**å¯¦éš›é©—è­‰**ï¼šâœ… **æº–ç¢º**

```bash
# grep_search çµæœ
No results found for "ScreenReaderAppLayout"
```

**ç¢ºèª**ï¼š`layouts/` ç›®éŒ„ä¸‹åªæœ‰ [DefaultAppLayout.tsx](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code/packages/cli/src/ui/layouts/DefaultAppLayout.tsx)ï¼Œæ²’æœ‰ `ScreenReaderAppLayout.tsx`ã€‚

---

### 4. App.tsx/AppContainer ç¼ºå°‘ SR æ¢ä»¶æ¸²æŸ“ âœ…
**å¯©æŸ¥å ±å‘Šè²ç¨±**ï¼šç¼ºå°‘æ¢ä»¶æ¸²æŸ“
**å¯¦éš›é©—è­‰**ï¼šâœ… **æº–ç¢º**

```typescript
// packages/cli/src/ui/AppContainer.tsx (Line 113 åƒ…å°å…¥ DefaultAppLayout)
import { DefaultAppLayout } from './layouts/DefaultAppLayout.js';

// AppContainer æœ«å°¾ (æœªé¡¯ç¤ºä½†å¯¦éš›å­˜åœ¨) åªæ¸²æŸ“ DefaultAppLayout
// æ²’æœ‰æ¢ä»¶åˆ‡æ›åˆ° ScreenReaderAppLayout
```

---

## âš ï¸éœ€è¦ä¿®æ­£çš„èª¤åˆ¤

### 1. pendingHistory æœªå¡«å…… âš ï¸ éƒ¨åˆ†æº–ç¢º

**å¯©æŸ¥å ±å‘Šè²ç¨±**ï¼š`pendingHistory` å®šç¾©ä½†å¾ä¸è¢«å¡«å……ï¼Œæ°¸é æ˜¯ç©ºé™£åˆ—
**å¯¦éš›é©—è­‰**ï¼šâš ï¸ **åŠå°åŠéŒ¯**

**å¯¦éš›ç‹€æ³**ï¼š
```typescript
// AppContainer.tsx Line 1530
pendingHistory: [], // Dynamic history for alternate buffer
```

**èª¤åˆ¤åŸå› **ï¼š
å¯©æŸ¥å ±å‘Šèªç‚ºæ‡‰è©²å¾ `pendingHistoryItems` è½‰æ›ï¼Œä½†å¯¦éš›ä¸Šï¼š
1. âœ… **éƒ¨åˆ†æ­£ç¢º**ï¼š`pendingHistory` ç¢ºå¯¦åˆå§‹åŒ–ç‚ºç©ºé™£åˆ—
2. âŒ **èª¤åˆ¤é»**ï¼šé€™ä¸ä¸€å®šæ˜¯ã€Œæ‡‰è©²ã€è¢«å¡«å……ï¼Œå¯èƒ½æ˜¯è¨­è¨ˆé¸æ“‡

**éœ€è¦ç¢ºèª**ï¼šgemini-cli æ˜¯å¦çœŸçš„ä½¿ç”¨ `pendingHistory`ï¼Ÿé‚„æ˜¯åªæ˜¯ç‚ºäº†é¡å‹å®Œæ•´æ€§è€Œå­˜åœ¨ï¼Ÿ

---

## ğŸ¯ å¯¦éš›ç¼ºå£æ¸…å–®ï¼ˆåŸºæ–¼é©—è­‰ï¼‰

### ğŸ”´ é—œéµç¼ºå¤±ï¼ˆç¢ºèªï¼‰

#### 1. ScreenReaderAppLayout.tsx **å®Œå…¨ç¼ºå¤±**
**å„ªå…ˆç´š**ï¼šğŸ”´ğŸ”´ğŸ”´ **æœ€é«˜**  
**å½±éŸ¿**ï¼šç„¡éšœç¤™æ€§é—œéµ

**éœ€è¦å‰µå»º**ï¼š
```
packages/cli/src/ui/layouts/ScreenReaderAppLayout.tsx
```

**åƒè€ƒ gemini-cli å¯¦æ–½**ï¼š
- Footer åœ¨é ‚éƒ¨ï¼ˆSR å„ªåŒ–ï¼‰
- å¯¬åº¦ 90%ï¼ˆæ›´é©åˆ SR é–±è®€ï¼‰
- çµ„ä»¶é †åºï¼šNotifications â†’ Footer â†’ MainContent â†’ Composer

---

#### 2. AppContainer ç¼ºå°‘ SR æ¢ä»¶æ¸²æŸ“
**å„ªå…ˆç´š**ï¼šğŸ”´ğŸ”´ğŸ”´ **æœ€é«˜**  
**å½±éŸ¿**ï¼šæ¶æ§‹å®Œæ•´æ€§

**éœ€è¦ä¿®æ”¹**ï¼š
```typescript
// AppContainer.tsx
import { useIsScreenReaderEnabled } from 'ink';
import { ScreenReaderAppLayout } from './layouts/ScreenReaderAppLayout.js';

// åœ¨æ¸²æŸ“éƒ¨åˆ†
const isScreenReaderEnabled = useIsScreenReaderEnabled();

return (
  // ... Provider wrappers
  {isScreenReaderEnabled ? (
    <ScreenReaderAppLayout config={config} />
  ) : (
    <DefaultAppLayout config={config} />
  )}
);
```

---

### ğŸŸ¡ æ¬¡è¦å„ªåŒ–ï¼ˆå¾…ç¢ºèªï¼‰

#### 3. pendingHistory å¡«å……é‚è¼¯
**å„ªå…ˆç´š**ï¼šğŸŸ¡ **ä¸­**ï¼ˆéœ€è¦å…ˆç¢ºèªè¨­è¨ˆæ„åœ–ï¼‰  
**å½±éŸ¿**ï¼šVirtualized æ¨¡å¼åŠŸèƒ½

**éœ€è¦èª¿æŸ¥**ï¼š
1. gemini-cli æ˜¯å¦çœŸçš„ä½¿ç”¨ `pendingHistory` æ¬„ä½ï¼Ÿ
2. é‚„æ˜¯åªæ˜¯ç‚ºäº†é¡å‹å®Œæ•´æ€§ï¼Ÿ
3. å¦‚æœéœ€è¦å¡«å……ï¼Œæ‡‰è©²å¾å“ªè£¡å–å¾—è³‡æ–™ï¼Ÿ

**æš«æ™‚çµè«–**ï¼šåœ¨æ²’æœ‰ç¢ºèª gemini-cli å¯¦éš›ç”¨æ³•å‰ï¼Œ**ä¸å»ºè­°ä¿®æ”¹**ã€‚

---

#### 4. é‡è¤‡çš„ useFlickerDetector èª¿ç”¨
**å¯©æŸ¥å ±å‘Šè²ç¨±**ï¼šDefaultAppLayout é‡è¤‡èª¿ç”¨
**å¯¦éš›é©—è­‰**ï¼šâ“ **éœ€è¦æª¢æŸ¥**ï¼ˆæœªåœ¨æ­¤æ¬¡é©—è­‰ä¸­æŸ¥çœ‹ DefaultAppLayout.tsxï¼‰

**å„ªå…ˆç´š**ï¼šğŸŸ¡ **ä½**  
**å½±éŸ¿**ï¼šä»£ç¢¼æ¸…æ½”åº¦

---

### ğŸŸ¢ æœªä¾†å¢å¼·ï¼ˆéé˜»å¡ï¼‰

#### 5. staticAreaMaxItemHeight ç´„æŸ
**å„ªå…ˆç´š**ï¼šğŸŸ¢ **ä½**  
**å½±éŸ¿**ï¼šStatic æ¨¡å¼ç©©å®šæ€§ï¼ˆgemini-cli æœ‰ï¼Œä½†éå¿…è¦ï¼‰

---

## ğŸ“Š èˆ‡ gemini-cli å°é½Šåº¦ï¼ˆä¿®æ­£å¾Œï¼‰

| åŠŸèƒ½ | gemini-cli | llxprt-code | å·®è· | å‚™è¨» |
| :--- | :--- | :--- | :---: | :--- |
| useRenderMode | âœ… è¤‡é›œé‚è¼¯ | âœ… ç°¡åŒ–é‚è¼¯ | ğŸŸ¢ 0% | æ›´å„ªé›… |
| ScreenReaderAppLayout | âœ… å°ˆç”¨çµ„ä»¶ | âŒ ç¼ºå¤± | ğŸ”´ 100% | **éœ€è¦å‰µå»º** |
| SR æ¢ä»¶æ¸²æŸ“ | âœ… App ç´šåˆ¥ | âŒ ç¼ºå¤± | ğŸ”´ 100% | **éœ€è¦æ·»åŠ ** |
| historyRemountKey | âœ… å¯¦ç¾ | âœ… å¯¦ç¾ | ğŸŸ¢ 0% | å®Œå…¨å°é½Š |
| pendingHistory | âœ… å®šç¾© | âœ… å®šç¾©ï¼ˆç©ºï¼‰ | ğŸŸ¡ ?% | **éœ€èª¿æŸ¥ç”¨æ³•** |
| FlickerDetector | âœ… åŸºç¤ç‰ˆ | âœ… å¢å¼·ç‰ˆ | ğŸŸ¢ -10% | è¶…è¶Š gemini |

**ç¸½é«”å°é½Šåº¦**ï¼š**70-75%** âœ…ï¼ˆä¿®æ­£å¾Œï¼‰

---

## ğŸ¯ å„ªå…ˆä¿®å¾©è¨ˆç•«

### Phase 1.1: ç„¡éšœç¤™æ”¯æ´å®Œæ•´åŒ–ï¼ˆå¿…é ˆï¼‰

**æ™‚é–“ä¼°è¨ˆ**ï¼š3-5 å°æ™‚

#### ä»»å‹™ 1ï¼šå‰µå»º ScreenReaderAppLayout.tsxï¼ˆ2-3 å°æ™‚ï¼‰
```typescript
// packages/cli/src/ui/layouts/ScreenReaderAppLayout.tsx
export const ScreenReaderAppLayout: React.FC<ScreenReaderAppLayoutProps> = ({
  config,
}) => {
  const uiState = useUIState();
  const { rootUiRef, terminalHeight, constrainHeight } = uiState;

  useFlickerDetector(rootUiRef, terminalHeight, constrainHeight);

  return (
    <Box
      flexDirection="column"
      width="90%"  // SR å„ªåŒ–å¯¬åº¦
      height="100%"
      ref={rootUiRef}
    >
      <Notifications />
      <Footer />  {/* Footer åœ¨é ‚éƒ¨ (SR å„ªåŒ–) */}
      <Box flexGrow={1} overflow="hidden">
        <MainContent config={config} />
      </Box>
      {uiState.isInputActive && <Composer />}
    </Box>
  );
};
```

#### ä»»å‹™ 2ï¼šä¿®æ”¹ AppContainer.tsx æ·»åŠ æ¢ä»¶æ¸²æŸ“ï¼ˆ1 å°æ™‚ï¼‰
```typescript
// 1. æ·»åŠ  imports
import { useIsScreenReaderEnabled } from 'ink';
import { ScreenReaderAppLayout } from './layouts/ScreenReaderAppLayout.js';

// 2. åœ¨ AppContainer å…§éƒ¨
const isScreenReaderEnabled = useIsScreenReaderEnabled();

// 3. ä¿®æ”¹æ¸²æŸ“é‚è¼¯
return (
  <StreamingContext.Provider value={streamingState}>
    <UIStateContext.Provider value={uiState}>
      <UIActionsContext.Provider value={uiActions}>
        {isScreenReaderEnabled ? (
          <ScreenReaderAppLayout config={config} />
        ) : (
          <DefaultAppLayout config={config} />
        )}
      </UIActionsContext.Provider>
    </UIStateContext.Provider>
  </StreamingContext.Provider>
);
```

#### ä»»å‹™ 3ï¼šæ¸¬è©¦èˆ‡é©—è­‰ï¼ˆ1-2 å°æ™‚ï¼‰
1. é©—è­‰ SR æ¨¡å¼å¸ƒå±€
2. é©—è­‰æ¨¡å¼åˆ‡æ›
3. é‹è¡Œæ¸¬è©¦å¥—ä»¶

---

### Phase 1.2: èª¿æŸ¥èˆ‡æ±ºç­–ï¼ˆå¯é¸ï¼‰

**æ™‚é–“ä¼°è¨ˆ**ï¼š2-3 å°æ™‚

#### ä»»å‹™ 4ï¼šèª¿æŸ¥ pendingHistory ç”¨æ³•
1. ç ”ç©¶ gemini-cli çš„ `pendingHistory` å¯¦éš›ç”¨æ³•
2. ç¢ºèªæ˜¯å¦éœ€è¦å¡«å……
3. å¦‚æœéœ€è¦ï¼Œå¯¦æ–½å¡«å……é‚è¼¯

---

### Phase 1.3: ä»£ç¢¼æ¸…ç†ï¼ˆä½å„ªå…ˆç´šï¼‰

**æ™‚é–“ä¼°è¨ˆ**ï¼š1-2 å°æ™‚

#### ä»»å‹™ 5ï¼šç§»é™¤é‡è¤‡çš„ useFlickerDetectorï¼ˆå¦‚æœ‰ï¼‰
#### ä»»å‹™ 6ï¼šè€ƒæ…® staticAreaMaxItemHeight å¯¦æ–½ï¼ˆæœªä¾†ï¼‰

---

## ğŸ“ ç¸½çµ

### å¯©æŸ¥å ±å‘Šè©•åƒ¹ï¼šB+ (æº–ç¢ºä½†ç•¥æœ‰éåº¦è§£è®€)

**æº–ç¢ºçš„éƒ¨åˆ†** (85%)ï¼š
- âœ… useRenderMode å¯¦æ–½æ­£ç¢º
- âœ… UIStateContext æ›´æ–°æ­£ç¢º
- âœ… ScreenReaderAppLayout å®Œå…¨ç¼ºå¤±
- âœ… SR æ¢ä»¶æ¸²æŸ“ç¼ºå¤±
- âœ… historyRemountKey æ­£ç¢ºå¯¦æ–½

**èª¤åˆ¤çš„éƒ¨åˆ†** (15%)ï¼š
- âš ï¸ pendingHistoryã€Œæœªå¡«å……ã€å¯èƒ½æ˜¯è¨­è¨ˆé¸æ“‡ï¼ŒééŒ¯èª¤
- âš ï¸ æŸäº›ã€Œå¿…é ˆã€ä¿®å¾©å¯¦éš›ä¸Šå¯èƒ½æ˜¯ã€Œå»ºè­°ã€å„ªåŒ–

### å¯¦éš›å¿…é ˆå®Œæˆçš„å·¥ä½œ

**é«˜å„ªå…ˆç´šï¼ˆæœ¬é€±ï¼‰**ï¼š
1. å‰µå»º ScreenReaderAppLayout.tsx
2. æ·»åŠ  SR æ¢ä»¶æ¸²æŸ“åˆ° AppContainer

**ä¸­å„ªå…ˆç´šï¼ˆä¸‹é€±ï¼‰**ï¼š
3. èª¿æŸ¥ pendingHistory ç”¨æ³•ä¸¦æ±ºå®šæ˜¯å¦éœ€è¦ä¿®æ”¹

**ä½å„ªå…ˆç´šï¼ˆæœªä¾†ï¼‰**ï¼š
4. ä»£ç¢¼æ¸…ç†ï¼ˆé‡è¤‡èª¿ç”¨ã€éœæ…‹å€åŸŸé«˜åº¦ç´„æŸç­‰ï¼‰

### ä¸‹ä¸€æ­¥è¡Œå‹•

**ç«‹å³è¡Œå‹•**ï¼šå¯¦æ–½ Phase 1.1ï¼ˆç„¡éšœç¤™æ”¯æ´å®Œæ•´åŒ–ï¼‰
**ä¼°è¨ˆæ™‚é–“**ï¼š3-5 å°æ™‚
**æˆæœ**ï¼šPhase 1 å®Œæ•´å¯¦æ–½ï¼Œé”åˆ° gemini-cli å°é½Šåº¦ 85-90%

**æ³¨æ„**ï¼šTabs åŠŸèƒ½ç”±å…¶ä»–åœ˜éšŠè™•ç†ï¼Œä¸åœ¨æ­¤æ¬¡å°é½Šç¯„åœå…§ã€‚
