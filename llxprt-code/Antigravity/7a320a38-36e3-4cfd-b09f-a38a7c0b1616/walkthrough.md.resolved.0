# WebFetch Signal Propagation Fix

I have fixed the issue where [GoogleWebFetchTool](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-2/packages/core/src/tools/google-web-fetch.ts#368-426) would not cancel the network request when the tool execution was cancelled.

## Changes

### Core Utils
#### [fetch.ts](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-2/packages/core/src/utils/fetch.ts)
- Updated [fetchWithTimeout](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/core/src/utils/fetch.ts#40-59) to accept an optional `signal: AbortSignal`.
- Added logic to listen to the external signal and abort the internal controller if the external signal is aborted.
- Added logic to correctly identify `AbortError` from [fetch](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/core/src/utils/fetch.ts#40-59) (handling both Node errors and DOMExceptions) and rethrow it as a [FetchError](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/core/src/utils/fetch.ts#21-30) with the correct message if it was user-initiated.

### Tools
#### [google-web-fetch.ts](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-2/packages/core/src/tools/google-web-fetch.ts)
- Updated [executeFallback](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-2/packages/core/src/tools/google-web-fetch.ts#82-133) to pass the `signal` from [execute](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/core/src/tools/web-fetch.ts#237-377) to [fetchWithTimeout](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/core/src/utils/fetch.ts#40-59).

## Verification Results

### Manual Verification
I created a manual test script [packages/core/src/utils/fetch.manual.test.ts](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-2/packages/core/src/utils/fetch.manual.test.ts) that verified:
1.  **Successful fetch**: [fetchWithTimeout](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/core/src/utils/fetch.ts#40-59) works as expected for normal requests.
2.  **Timeout**: [fetchWithTimeout](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/core/src/utils/fetch.ts#40-59) correctly times out if the request takes too long.
3.  **Abort**: [fetchWithTimeout](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/core/src/utils/fetch.ts#40-59) correctly aborts if the external `AbortSignal` is triggered.

All tests passed.

```
Starting test...
Test 1: Successful fetch (google.com)
Test 1 Passed
Test 2: Timeout (1ms)
Test 2 Passed: Timed out as expected
Test 3: Abort
Test 3 Passed: Aborted as expected
```
