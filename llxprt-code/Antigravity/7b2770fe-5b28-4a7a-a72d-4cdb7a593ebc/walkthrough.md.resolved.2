# Fix MouseContext Error Walkthrough

## Problem
The application was crashing with the error: `Error: useMouseContext must be used within a MouseProvider`.
This happened because UI components like [ScrollableList](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/components/shared/ScrollableList.tsx#44-248) rely on [MouseContext](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/MouseContext.tsx#38-45), but the [MouseProvider](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/MouseContext.tsx#59-167) was missing from the component tree in `llxprt-code-3`.

## Solution
We added [MouseProvider](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/MouseContext.tsx#59-167) and [ScrollProvider](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/ScrollProvider.tsx#76-350) to the [AppWrapper](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/App.tsx#33-84) component in [packages/cli/src/ui/App.tsx](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/cli/src/ui/App.tsx), mirroring the structure in `gemini-cli`.

### Changes

#### [packages/cli/src/ui/App.tsx](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/App.tsx)
- Imported [MouseProvider](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/MouseContext.tsx#59-167), [ScrollProvider](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/ScrollProvider.tsx#76-350), and [isAlternateBufferEnabled](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/hooks/useAlternateBuffer.ts#10-12).
- Wrapped the application context stack with [MouseProvider](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/MouseContext.tsx#59-167) and [ScrollProvider](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/ScrollProvider.tsx#76-350).
- Configured `mouseEventsEnabled` based on settings and screen reader status.

## Verification
Ran `npm run test` in `packages/cli` and all 132 tests passed.

```bash
Test Files  132 passed | 1 skipped (133) 
Tests  1559 passed | 11 skipped (1570)
```

## Fix: InputPrompt Mouse Interaction and Shell Focus

### Problem
The [InputPrompt](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/components/InputPrompt.tsx#106-1056) component in `llxprt-code-3` lacked mouse interaction features (right-click paste, click-to-move-cursor) present in `gemini-cli`. Additionally, the `isEmbeddedShellFocused` state was not being passed from [Composer](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/components/Composer.tsx#20-154), causing potential focus management issues.

### Solution
1.  **[InputPrompt.tsx](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/cli/src/ui/components/InputPrompt.tsx)**:
    *   Added `useMouseClick` to handle cursor positioning.
    *   Added [useMouse](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/MouseContext.tsx#46-58) to handle right-click paste.
    *   Integrated `isEmbeddedShellFocused` prop.
2.  **`TextBuffer.ts`**:
    *   Implemented `moveToVisualPosition` to support accurate cursor placement based on visual coordinates (handling wrapped lines).
    *   Added `set_cursor` action to the reducer.
3.  **[Composer.tsx](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/components/Composer.tsx)**:
    *   Passed `embeddedShellFocused` from [UIState](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/contexts/UIStateContext.tsx#33-177) to [InputPrompt](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/components/InputPrompt.tsx#106-1056).

### Verification
*   **Lint Checks**: Ran `npm run lint` - Passed.
*   **Unit Tests**: Created a temporary test file [src/utils/text-buffer-visual.test.ts](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/utils/text-buffer-visual.test.ts) to verify `moveToVisualPosition` logic, including edge cases like line wrapping and out-of-bounds coordinates. All tests passed.

## Fix: DefaultAppLayout Structure Alignment

### Problem
[DefaultAppLayout.tsx](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/cli/src/ui/layouts/DefaultAppLayout.tsx) in `llxprt-code-3` used a hardcoded width of `90%`, which could lead to layout inconsistencies and didn't account for the alternate buffer mode used in `gemini-cli`. It also lacked the flicker detection mechanism present in the upstream project.

### Solution
Updated [packages/cli/src/ui/layouts/DefaultAppLayout.tsx](file:///Users/caishanghong/Shopify/cli-tool/gemini-cli/packages/cli/src/ui/layouts/DefaultAppLayout.tsx) to:
1.  Import and use [useFlickerDetector](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/hooks/useFlickerDetector.ts#11-44) (with `constrainHeight` argument) to monitor UI stability.
2.  Import and use [useAlternateBuffer](file:///Users/caishanghong/Shopify/cli-tool/llxprt-code-3/packages/cli/src/ui/hooks/useAlternateBuffer.ts#13-17) to determine the correct layout mode.
3.  Dynamically calculate the `width` prop:
    *   Use `terminalWidth` when in alternate buffer mode.
    *   Use `mainAreaWidth` otherwise.
4.  Adjust the `height` prop to account for the scrollbar in alternate buffer mode.

### Verification
*   **Lint Checks**: Ran `npm run lint` - Passed.
*   **Manual Verification**: Verified that the layout adapts correctly and the code compiles without errors.
